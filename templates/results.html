{% extends 'base.html' %}

{% block title %}Economic Damages Calculation{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/results-minimalist.css') }}">
{% endblock %}

{% block content %}
<div class="container results-container">
    <div class="results-header">
        <div class="header-content">
            <h1>Economic Damages Assessment</h1>
            <div class="download-section">
                {% if filename %}
                <a href="{{ url_for('download', filename=filename) }}" class="btn btn-primary download-btn">
                    <i class="fas fa-download"></i> Download Full Report
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="damages-summary-card">
        <table class="table damages-summary-table">
            <tbody>
                <tr>
                    <td>Past Lost Wages</td>
                    <td class="text-end">${{ "{:,.2f}".format(net_past_lost_wages) }}</td>
                </tr>
                <tr>
                    <td>Future Lost Wages</td>
                    <td class="text-end">${{ "{:,.2f}".format(present_value_details.get('present_value', 0)) }}</td>
                </tr>
                <tr class="total-row">
                    <td>Total Economic Damages</td>
                    <td class="text-end">${{ "{:,.2f}".format(net_past_lost_wages + present_value_details.get('present_value', 0)) }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="calculation-section">
        <div class="row">
            <div class="col-md-6">
               <div class="card income-summary">
                   <h2>Income Summary</h2>
                   <table class="table">
                       <tbody>
                           <tr>
                               <td>Gross Income</td>
                               <td class="text-end">${{ "{:,.2f}".format(result.get("Gross Income", 0)) }}</td>
                           </tr>
                           {% if result.get('Dependent Benefit', 0) > 0 %}
                           <tr>
                               <td>Dependent Deduction</td>
                               <td class="text-end">${{ "{:,.2f}".format(result.get('Dependent Benefit', 0)) }}</td>
                           </tr>
                           {% endif %}
                           <tr>
                               <td>Federal Tax</td>
                               <td class="text-end">-${{ "{:,.2f}".format(result.get('Federal Tax', 0)) }}</td>
                           </tr>
                           <tr>
                               <td>Provincial Tax</td>
                               <td class="text-end">-${{ "{:,.2f}".format(result.get('Nova scotia Tax', 0)) }}</td>
                           </tr>
                           <tr>
                               <td>CPP/EI Contributions</td>
                               <td class="text-end">-${{ "{:,.2f}".format(result.get('CPP Contribution', 0) + result.get('EI Contribution', 0)) }}</td>
                           </tr>
                           <tr class="total-row">
                               <td>Net Income</td>
                               <td class="text-end">${{ "{:,.2f}".format(result.get('Net Pay (Provincially specific deductions for damages)', 0)) }}</td>
                           </tr>
                       </tbody>
                   </table>
               </div>
            </div>

            <div class="col-md-6">
                <div class="card past-lost-wages">
                    <h2>Past Lost Wages</h2>
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>Gross Missed Income</td>
                                <td class="text-end">${{ "{:,.2f}".format(missed_pay) }}</td>
                            </tr>
                            <tr>
                                <td>Collateral Benefits Deduction</td>
                                <td class="text-end">-${{ "{:,.2f}".format(collateral_benefits.get('Total Past Benefits', 0)) }}</td>
                            </tr>
                            <tr class="total-row">
                                <td>Net Past Lost Wages</td>
                                <td class="text-end">${{ "{:,.2f}".format(net_past_lost_wages) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card future-lost-wages">
                    <h2>Future Lost Wages</h2>
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>Annual Net Salary</td>
                                <td class="text-end">${{ "{:,.2f}".format(present_value_details.get('annual_salary', 0)) }}</td>
                            </tr>
                            <tr>
                                <td>Annual Collateral Benefits</td>
                                <td class="text-end">-${{ "{:,.2f}".format(collateral_benefits.get('Total Annual Future Benefits', 0)) }}</td>
                            </tr>
                            <tr>
                                <td>Time Horizon</td>
                                <td class="text-end">{{ "{:.2f} years".format(present_value_details.get('time_horizon', 0)) }}</td>
                            </tr>
                            <tr>
                                <td>Discount Rate</td>
                                <td class="text-end">{{ "{:.2f}%".format(present_value_details.get('discount_rate', 0) * 100) }}</td>
                            </tr>
                            <tr class="total-row">
                                <td>Present Value of Future Lost Wages</td>
                                <td class="text-end">${{ "{:,.2f}".format(present_value_details.get('present_value', 0)) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card pre-judgment-interest">
                    <h2>Pre-Judgment Interest (PJI) Calculation</h2>
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>Base Amount</td>
                                <td class="text-end">${{ "{:,.2f}".format(calculation_details.get('Base Amount', 0)) }}</td>
                            </tr>
                            <tr>
                                <td>PJI Rate</td>
                                <td class="text-end">{{ "{:.2f}%".format(calculation_details.get('PJI Rate', 0)) }}</td>
                            </tr>
                            <tr>
                                <td>Loss Date</td>
                                <td class="text-end">{{ loss_date.strftime("%Y-%m-%d") if loss_date is defined else "Not specified" }}</td>
                            </tr>
                            <tr>
                                <td>Calculation Date</td>
                                <td class="text-end">{{ current_date.strftime("%Y-%m-%d") if current_date is defined else "Not specified" }}</td>
                            </tr>
                            <tr>
                                <td>Years Between</td>
                                <td class="text-end">{{ "{:.2f}".format(calculation_details.get('Years Between', 0)) }}</td>
                            </tr>
                            <tr class="total-row">
                                <td>Pre-Judgment Interest Amount</td>
                                <td class="text-end">${{ "{:,.2f}".format(calculation_details.get('Interest Amount', 0)) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const totalElement = document.querySelector('.damages-summary-table .total-row .text-end');
    if (totalElement) {
        const amount = parseFloat(totalElement.textContent.replace(/[,$]/g, ''));
        animateCounter(totalElement, amount);
    }

    function animateCounter(element, finalValue, duration = 1500) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const currentValue = progress * finalValue;
            element.textContent = '$' + currentValue.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
});
</script>
{% endblock %}